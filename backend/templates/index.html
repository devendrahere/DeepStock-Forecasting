<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DeepStock - LSTM Stock Price Forecasting</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Plotly (interactive charts) -->
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>

<body class="bg-light">
    <div class="container py-4">

        <h1 class="mb-3">DeepStock: LSTM Stock Price Forecasting</h1>
        <p class="text-muted">Enter a stock symbol, train the model, and forecast future prices.</p>

        <!-- ================= TRAINING CARD ================= -->
        <div class="card mb-3">
            <div class="card-body">
                <form id="trainForm" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Ticker</label>
                        <input type="text" class="form-control" id="ticker" value="AAPL" required>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Period</label>
                        <select class="form-select" id="period">
                            <option value="1y">1 year</option>
                            <option value="3y">3 years</option>
                            <option value="5y" selected>5 years</option>
                        </select>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">Train Model</button>
                    </div>
                </form>

                <div id="trainStatus" class="mt-3 text-success"></div>
            </div>
        </div>

        <!-- ================= PREDICTION CARD ================= -->
        <div class="card mb-3">
            <div class="card-body">
                <form id="predictForm" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Ticker</label>
                        <input type="text" class="form-control" id="tickerPredict" value="AAPL" required>
                    </div>
                    <div class="text-center mb-3">
                        <img id="stockLogo" src="" style="max-height:80px;" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Days to Forecast</label>
                        <input type="number" class="form-control" id="days" value="30" min="1" max="120" required>
                    </div>

                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">Predict</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ================= CHART CARD ================= -->
        <div class="card">
            <div class="card-body">
                <div id="priceChart" style="height: 500px;"></div>
            </div>
        </div>

    </div>

    <!-- ========================== JAVASCRIPT ========================== -->
    <script>

        const trainForm = document.getElementById('trainForm');
        const predictForm = document.getElementById('predictForm');
        const trainStatus = document.getElementById('trainStatus');

        // ========================== TRAIN MODEL ==========================
        trainForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            trainStatus.innerText = "Training model... (this will take a moment)";

            const ticker = document.getElementById('ticker').value;
            const period = document.getElementById('period').value;

            const formData = new FormData();
            formData.append("ticker", ticker);
            formData.append("period", period);

            const res = await fetch('/api/train', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            trainStatus.innerText =
                `Training complete for ${data.ticker}. RMSE: ${data.metrics.rmse.toFixed(2)}`;
        });

        // ========================== PREDICT ==========================
        predictForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const ticker = document.getElementById('tickerPredict').value;
            const days = parseInt(document.getElementById('days').value);

            const res = await fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ticker, days })
            });

            const data = await res.json();

            const historicalDates = data.historical_dates;
            const historicalPrices = data.historical_prices;
            const futureDates = data.future_dates;
            const futurePrices = data.future_prices;
            // Fetch logo
            const logoRes = await fetch(`/api/logo/${ticker}`);
            const logoData = await logoRes.json();
            if (logoData.logo) {
                document.getElementById("stockLogo").src = logoData.logo;
            } else {
                document.getElementById("stockLogo").src = "https://via.placeholder.com/80?text=No+Logo";
            }


            // Clear previous chart
            document.getElementById('priceChart').innerHTML = "";

            // Historical line
            const traceHistorical = {
                x: historicalDates,
                y: historicalPrices,
                mode: 'lines',
                name: 'Historical Close',
                line: { width: 2, color: 'blue' }
            };

            // Forecast line
            const traceForecast = {
                x: futureDates,
                y: futurePrices,
                mode: 'lines',
                name: 'Forecast',
                line: { width: 2, color: 'red', dash: 'dash' }
            };

            // Plot layout
            const layout = {
                title: `${ticker} Stock Price Forecast`,
                xaxis: {
                    title: "Date",
                    rangeslider: { visible: true },
                    rangeselector: {
                        buttons: [
                            { step: 'month', count: 1, label: '1m', stepmode: 'backward' },
                            { step: 'month', count: 6, label: '6m', stepmode: 'backward' },
                            { step: 'year', count: 1, label: '1y', stepmode: 'backward' },
                            { step: 'all', label: 'All' }
                        ]
                    }
                },
                yaxis: { title: "Price (USD)" },
                hovermode: 'x unified'
            };

            // Draw chart
            Plotly.newPlot('priceChart', [traceHistorical, traceForecast], layout, {
                responsive: true,
                displaylogo: false
            });

        });

    </script>

</body>

</html>